name: rivalbot-deploy
on:
  push:
    branches:
      # Eventually, make this only fire on pushes to main.
      - '*'
      # - 'main'

jobs:
  deploy-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: '**/package-lock.json'
      - name: Run `npm ci`
        run: npm ci
      - name: Run Tests
        run: npm test

  # build:
  #   runs-on: ubuntu-latest
  #   needs: [deploy-tests]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #         cache: npm
  #         cache-dependency-path: '**/package-lock.json'
  #     - name: Setup Cache for Build
  #       uses: actions/cache@v3
  #       with:
  #         key: build-${{ github.run_id }}
  #         path: |
  #           testfile.txt
  #     - name: Build Project
  #       run: echo "${{ github.run_id }}" > testfile.txt

  deploy-to-pi:
    runs-on: ubuntu-latest
    needs: [deploy-tests]
    # needs: [build]
    steps:
      - uses: actions/checkout@v3
      # - name: Restore Build
      #   uses: actions/cache@v3
      #   with:
      #     key: build-${{ github.run_id }}
      #     path: |
      #       testfile.txt
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.PI_SSH_PRIVATE_KEY }}" > ~/.ssh/pi.key
          chmod 600 ~/.ssh/pi.key
          cat >>~/.ssh/config <<END
          Host pi
            HostName ${{ secrets.PI_IP_ADDRESS }}
            User ${{ secrets.PI_USERNAME }}
          IdentityFile ~/.ssh/pi.key
            StrictHostKeyChecking no
          END
      - name: Down RivalBot
        run: ssh pi 'cd RivalBot && ./down.sh'
      - name: Add 'Build' Files
      # run: ssh pi 'touch ~/testfile.txt
        run: scp -r dist/* pi:~/RivalBot/build
      # - name: Restart RivalBot
      #   run: ssh pi 'cd RivalBot && ./up.sh'
